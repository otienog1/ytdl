# YouTube Cookie Setup with Puppeteer

Since the SOCKS5 proxy approach isn't working due to ISP restrictions, we'll use **Puppeteer** to extract YouTube cookies automatically. This is more reliable and doesn't require port forwarding.

## How It Works

1. **Run the cookie extractor script** on your server
2. **A browser opens** showing YouTube
3. **You log in** to your Google/YouTube account
4. **Cookies are extracted and saved** in Netscape format
5. **yt-dlp uses the cookies** for authenticated downloads

## Prerequisites

- Node.js installed on the server
- X11 forwarding enabled (for headless server) OR use Xvfb

## Installation

### Step 1: Install Node.js (if not already installed)

```bash
ssh root@172.234.172.191

# Check if Node.js is installed
node --version

# If not installed, install Node.js 18+
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs
```

### Step 2: Install Dependencies

```bash
cd /opt/ytdl
npm install
```

This will install Puppeteer and download Chromium automatically.

### Step 3: Install Xvfb (for headless servers)

Since the server doesn't have a display, we need a virtual display:

```bash
sudo apt-get update
sudo apt-get install -y xvfb x11vnc
```

## Extract Cookies

### Option 1: Using Xvfb (Recommended for servers)

Run the script with a virtual display:

```bash
cd /opt/ytdl
xvfb-run -a --server-args="-screen 0 1280x800x24" node extract-youtube-cookies.js
```

**Then use VNC to connect and login:**

1. **Start VNC server** (in another SSH session):
   ```bash
   x11vnc -display :99 -nopw -listen localhost -xkb
   ```

2. **Create SSH tunnel from your computer**:
   ```bash
   ssh -L 5900:localhost:5900 root@172.234.172.191
   ```

3. **Connect with VNC client**:
   - Use a VNC viewer (RealVNC, TigerVNC, etc.)
   - Connect to `localhost:5900`
   - You'll see the browser window
   - Log in to YouTube
   - Return to terminal and press ENTER

### Option 2: Using X11 Forwarding (Alternative)

If you have X11 on your local machine:

```bash
# From your computer, connect with X11 forwarding
ssh -X root@172.234.172.191

# Run the script
cd /opt/ytdl
node extract-youtube-cookies.js
```

The browser will open on your local machine.

### Option 3: Run Locally, Upload Cookies (Easiest)

**On your local computer:**

1. Copy the script to your computer:
   ```bash
   scp root@172.234.172.191:/opt/ytdl/extract-youtube-cookies.js .
   scp root@172.234.172.191:/opt/ytdl/package.json .
   ```

2. Install dependencies locally:
   ```bash
   npm install
   ```

3. Run the script:
   ```bash
   node extract-youtube-cookies.js
   ```

4. Browser opens → Log in to YouTube → Press ENTER

5. Upload the cookie file to server:
   ```bash
   scp youtube_cookies.txt root@172.234.172.191:/opt/ytdl/
   ```

6. Set correct permissions:
   ```bash
   ssh root@172.234.172.191
   sudo chown ytd:ytd /opt/ytdl/youtube_cookies.txt
   sudo chmod 600 /opt/ytdl/youtube_cookies.txt
   ```

## Configure Backend to Use Cookies

The backend is already configured to use cookies from `youtube_cookies.txt`. Just verify:

```bash
ssh root@172.234.172.191
cat /opt/ytdl/.env.production | grep COOKIES
```

Should show:
```bash
YOUTUBE_COOKIES_FILE=/opt/ytdl/youtube_cookies.txt
```

If not, add it:

```bash
sudo nano /opt/ytdl/.env.production
```

Add this line:
```bash
YOUTUBE_COOKIES_FILE=/opt/ytdl/youtube_cookies.txt
```

## Remove Proxy Configuration

Since we're using cookies instead of proxy, remove the proxy setting:

```bash
ssh root@172.234.172.191
sudo sed -i '/YT_DLP_PROXY/d' /opt/ytdl/.env.production
```

Or edit manually:
```bash
sudo nano /opt/ytdl/.env.production
# Remove or comment out the YT_DLP_PROXY line
```

## Restart Services

```bash
sudo systemctl restart ytd-api ytd-worker
```

## Test

1. Go to https://ytd.timobosafaris.com
2. Try downloading a YouTube Short
3. Check logs:
   ```bash
   sudo journalctl -u ytd-worker -f
   ```

You should see:
```
Using cookies from file: /opt/ytdl/youtube_cookies.txt
```

## Verify Cookie File

Check if cookies were saved correctly:

```bash
cat /opt/ytdl/youtube_cookies.txt | head -20
```

Should show cookies in Netscape format:
```
# Netscape HTTP Cookie File
# This file is generated by Puppeteer. Do not edit.

.youtube.com	TRUE	/	TRUE	1234567890	SSID	...
.youtube.com	TRUE	/	TRUE	1234567890	APISID	...
```

Important cookies to look for:
- `SSID`
- `APISID`
- `SAPISID`
- `LOGIN_INFO`
- `__Secure-1PSID`

## Troubleshooting

### "Chromium revision is not downloaded"

```bash
cd /opt/ytdl
npm install puppeteer --force
```

### "Error: Failed to launch the browser process"

Install missing dependencies:
```bash
sudo apt-get install -y \
  ca-certificates \
  fonts-liberation \
  libappindicator3-1 \
  libasound2 \
  libatk-bridge2.0-0 \
  libatk1.0-0 \
  libc6 \
  libcairo2 \
  libcups2 \
  libdbus-1-3 \
  libexpat1 \
  libfontconfig1 \
  libgbm1 \
  libgcc1 \
  libglib2.0-0 \
  libgtk-3-0 \
  libnspr4 \
  libnss3 \
  libpango-1.0-0 \
  libpangocairo-1.0-0 \
  libstdc++6 \
  libx11-6 \
  libx11-xcb1 \
  libxcb1 \
  libxcomposite1 \
  libxcursor1 \
  libxdamage1 \
  libxext6 \
  libxfixes3 \
  libxi6 \
  libxrandr2 \
  libxrender1 \
  libxss1 \
  libxtst6 \
  lsb-release \
  wget \
  xdg-utils
```

### "No cookies found"

Make sure you:
1. Actually logged in to YouTube (not just visited the page)
2. Waited for the page to fully load after login
3. Pressed ENTER in the terminal after logging in

### Cookies expire

YouTube cookies typically last 30-90 days. When downloads start failing again, re-run the cookie extraction script.

## Automation (Optional)

To automatically refresh cookies before they expire, create a cron job:

```bash
# Edit crontab
crontab -e

# Add this line to run every 30 days
0 0 1 * * cd /opt/ytdl && xvfb-run -a node extract-youtube-cookies.js
```

**Note**: This won't work fully automated since you need to log in. You'll need to run it manually every 30-60 days.

## Security Notes

1. **Protect the cookie file**:
   ```bash
   sudo chmod 600 /opt/ytdl/youtube_cookies.txt
   sudo chown ytd:ytd /opt/ytdl/youtube_cookies.txt
   ```

2. **Don't commit cookies to Git**:
   - The file is already in `.gitignore`

3. **Use app-specific password** (if 2FA enabled):
   - Google Account → Security → 2-Step Verification → App passwords

## Summary

The Puppeteer approach is **simpler and more reliable** than the proxy:

✅ No port forwarding needed
✅ No ISP restrictions
✅ Works with any network setup
✅ One-time setup (cookies last 30-90 days)
✅ Easy to re-run when cookies expire

❌ Need to re-run every 30-90 days when cookies expire
❌ Slightly more complex initial setup (Xvfb/VNC)

## Quick Reference

**Extract cookies locally (easiest):**
```bash
# On your computer
node extract-youtube-cookies.js
scp youtube_cookies.txt root@172.234.172.191:/opt/ytdl/
ssh root@172.234.172.191 "sudo chown ytd:ytd /opt/ytdl/youtube_cookies.txt && sudo systemctl restart ytd-worker"
```

**Check if cookies are being used:**
```bash
sudo journalctl -u ytd-worker -f | grep cookies
```

**Remove proxy config:**
```bash
sudo sed -i '/YT_DLP_PROXY/d' /opt/ytdl/.env.production
sudo systemctl restart ytd-worker
```
